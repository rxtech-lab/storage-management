name: iOS Setup

on:
  workflow_call:
    inputs:
      runs-on:
        description: 'Runner to use'
        required: false
        type: string
        default: 'macos-latest'
      job-name:
        description: 'Name of the job'
        required: true
        type: string
      script:
        description: 'Script to run (e.g., ios-build.sh, ios-test.sh, macos-build.sh)'
        required: true
        type: string
      scheme:
        description: 'Xcode scheme to build'
        required: false
        type: string
        default: 'RxStorage'
      configuration:
        description: 'Build configuration'
        required: false
        type: string
        default: 'Debug'
      sdk:
        description: 'SDK to use'
        required: false
        type: string
        default: 'iphonesimulator'
      artifact-name:
        description: 'Name for uploaded artifacts'
        required: false
        type: string
        default: 'build-logs'
      artifact-path:
        description: 'Path to artifact file'
        required: false
        type: string
        default: 'build.log'
      upload-test-results:
        description: 'Whether to upload test results'
        required: false
        type: boolean
        default: false

jobs:
  run:
    name: ${{ inputs.job-name }}
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Secrets.xcconfig from GitHub Secrets
        env:
          SECRETS_XCCONFIG_BASE64: ${{ secrets.SECRETS_XCCONFIG_BASE64 }}
        run: |
          if [ -z "$SECRETS_XCCONFIG_BASE64" ]; then
            echo "⚠️ Warning: SECRETS_XCCONFIG_BASE64 secret is not set"
            echo "Creating a default Secrets.xcconfig for CI build"
            cat > RxStorage/RxStorage/Config/Secrets.xcconfig << 'EOF'
          // Secrets.xcconfig - CI Generated
          // This file is auto-generated in CI from GitHub secrets

          // Development OAuth Client ID
          AUTH_CLIENT_ID_DEV = client_ci_placeholder

          // Production OAuth Client ID
          AUTH_CLIENT_ID_PROD = client_ci_placeholder
          EOF
          else
            echo "✅ Decoding Secrets.xcconfig from GitHub secrets"
            echo "$SECRETS_XCCONFIG_BASE64" | base64 --decode > RxStorage/RxStorage/Config/Secrets.xcconfig
          fi

          echo "Contents of Secrets.xcconfig (with secrets masked):"
          sed 's/\(AUTH_CLIENT_ID.*=\).*/\1 ***/' RxStorage/RxStorage/Config/Secrets.xcconfig

      - name: Setup .env from GitHub Secrets
        env:
          RXSTORAGE_TESTING_SECRETS: ${{ secrets.RXSTORAGE_TESTING_SECRETS }}
        run: ./scripts/decode-env-secrets.sh

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Cache Xcode Build
        uses: irgaly/xcode-cache@v1
        with:
          key: xcode-${{ runner.os }}-${{ hashFiles('RxStorage/RxStorageCore/Package.swift') }}
          restore-keys: xcode-${{ runner.os }}-

      - name: Start Backend Server
        run: bun install && bun dev:e2e &
        working-directory: admin

      - name: Wait for Backend Server
        run: |
          echo "Waiting for backend server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3000; then
              echo "Backend server is up!"
              exit 0
            fi
            sleep 2
          done
          echo "Backend server did not start in time."
          exit 1

      - name: Generate openapi documentation
        run: ./scripts/ios-update-openapi.sh

      - name: Run Script
        run: ./scripts/${{ inputs.script }}
        env:
          SCHEME: ${{ inputs.scheme }}
          CONFIGURATION: ${{ inputs.configuration }}
          SDK: ${{ inputs.sdk }}

      - name: Upload Logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-path }}
          retention-days: 7

      - name: Upload Test Results
        if: ${{ inputs.upload-test-results && always() }}
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: test-results.xcresult
          retention-days: 7

      - name: Generate Test Report
        if: ${{ inputs.upload-test-results && always() }}
        run: |
          if [ -d "test-results.xcresult" ]; then
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test results bundle available in artifacts." >> $GITHUB_STEP_SUMMARY
          fi
