name: iOS CI

on:
  push
  
env:
  SCHEME: RxStorage
  CONFIGURATION: Debug
  SDK: iphonesimulator
  DESTINATION: 'platform=iOS Simulator,name=iPhone 15,OS=latest'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Secrets.xcconfig from GitHub Secrets
        env:
          SECRETS_XCCONFIG_BASE64: ${{ secrets.SECRETS_XCCONFIG_BASE64 }}
        run: |
          if [ -z "$SECRETS_XCCONFIG_BASE64" ]; then
            echo "⚠️ Warning: SECRETS_XCCONFIG_BASE64 secret is not set"
            echo "Creating a default Secrets.xcconfig for CI build"
            cat > RxStorage/RxStorage/Config/Secrets.xcconfig << 'EOF'
          // Secrets.xcconfig - CI Generated
          // This file is auto-generated in CI from GitHub secrets

          // Development OAuth Client ID
          AUTH_CLIENT_ID_DEV = client_ci_placeholder

          // Production OAuth Client ID
          AUTH_CLIENT_ID_PROD = client_ci_placeholder
          EOF
          else
            echo "✅ Decoding Secrets.xcconfig from GitHub secrets"
            echo "$SECRETS_XCCONFIG_BASE64" | base64 --decode > RxStorage/RxStorage/Config/Secrets.xcconfig
          fi

          echo "Contents of Secrets.xcconfig (with secrets masked):"
          sed 's/\(AUTH_CLIENT_ID.*=\).*/\1 ***/' RxStorage/RxStorage/Config/Secrets.xcconfig

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            RxStorage/.build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('RxStorage/RxStorageCore/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build iOS App
        run: ./scripts/ios-build.sh
        env:
          SCHEME: ${{ env.SCHEME }}
          CONFIGURATION: ${{ env.CONFIGURATION }}
          SDK: ${{ env.SDK }}
          DESTINATION: ${{ env.DESTINATION }}

      - name: Run Tests
        run: ./scripts/ios-test.sh
        env:
          SCHEME: ${{ env.SCHEME }}
          CONFIGURATION: ${{ env.CONFIGURATION }}
          SDK: ${{ env.SDK }}
          DESTINATION: ${{ env.DESTINATION }}

      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: build-logs
          path: |
            build.log
            test.log
          retention-days: 7

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: test-results.xcresult
          retention-days: 7

      - name: Generate Test Report
        if: always()
        run: |
          if [ -d "test-results.xcresult" ]; then
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test results bundle available in artifacts." >> $GITHUB_STEP_SUMMARY
          fi

  build-app-clips:
    name: Build App Clips
    runs-on: macos-14
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

      - name: Setup Secrets.xcconfig from GitHub Secrets
        env:
          SECRETS_XCCONFIG_BASE64: ${{ secrets.SECRETS_XCCONFIG_BASE64 }}
        run: |
          if [ -z "$SECRETS_XCCONFIG_BASE64" ]; then
            echo "⚠️ Warning: SECRETS_XCCONFIG_BASE64 secret is not set"
            cat > RxStorage/RxStorage/Config/Secrets.xcconfig << 'EOF'
          // Secrets.xcconfig - CI Generated
          AUTH_CLIENT_ID_DEV = client_ci_placeholder
          AUTH_CLIENT_ID_PROD = client_ci_placeholder
          EOF
          else
            echo "✅ Decoding Secrets.xcconfig from GitHub secrets"
            echo "$SECRETS_XCCONFIG_BASE64" | base64 --decode > RxStorage/RxStorage/Config/Secrets.xcconfig
          fi

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Build App Clips
        run: ./scripts/ios-build.sh
        env:
          SCHEME: RxStorageClips
          CONFIGURATION: ${{ env.CONFIGURATION }}
          SDK: ${{ env.SDK }}
          DESTINATION: ${{ env.DESTINATION }}

      - name: Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: app-clips-build-logs
          path: build.log
          retention-days: 7
